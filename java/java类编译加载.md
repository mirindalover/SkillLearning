
# java类 编译、加载

## Java的编译

>	<clinit>()类构造器方法
>	<init>()构造方法

-	静态变量|静态代码块：放在<clinit>()中

-	非静态变量|非静态代码块：放在<init>()中

-	内部类

>	会编译成跟外部类一样的顶级类

	*	静态内部类直接编译,与普通的外部类没有区别
	
	*	非静态内部类:需要外部类的实例才能加载类
>	构造方法中添加了外部类实例的引用，用以访问外部类
>	所以内部类不可以有静态方法,防止可以使用类名来方法

	*	非静态内部类与外部类访问
>	由于无法直接访问,所以生成对应的access&xxx方法,来访问变量和方法

-	匿名内部类

>	跟非静态内部类一样,命名：外部类&num(出现顺序累加)	

### 编译优化

-	方法内联

>	方法的调用需要进栈、出栈,消耗时间
>	JVM对一些方法比较短,调用频率高德方法,直接使用方法体替换

-	方法裁剪

>	方法参数没有使用到,编译时会把参数擦除

-	指令重排

>	程序的最终结果等同于在严格的顺序话下的结果,指令的执行顺序可能与代码的顺序不一致
>
>	意义:JVM能够根据处理器的特性(CPU的多级缓存系统、多核处理器等)适当的重新排序机器指令,使机器指令更符合CPU的执行特点，最大限度的发挥机器的性能

-	同步消除

>	多线程中,确认对象不会线程逃逸,JVM可以不进行同步操作

-	标量替换

>	方法内的对象,不逃逸,并且可以进一步分解。JVM不会创建对象,而是将对象成员变量分解若干被方法使用的变量

-	栈上分配

>	方法内的对象,不逃逸。可以优化为在栈中分配空间,随方法一同出栈。有时会和标量替换一同使用

-	Tips

>	方法逃逸:对象在方法中创建,在其他方法也可以访问
>	线程逃逸:在一个线程中创建的对象,其他线程也可以访问

##	Java类的加载

-	类生命周期:加载--连接(验证、准备、解析)--初始化--使用--卸载

###	加载

1. 类加载器在指定路径中查找二进制文件(不一定是class文件，可以是网络，动态生成、数据库)

2. 将二进制文件的静态存储结构转换成 方法区的运行时结构

3. 生成Class对象,作为方法区这个类的各种数据访问入口

-	Tips

>	Java类都有一个Class对象,在编写且编译后保存在同步的class文件中	

###	连接

1. 验证：文件格式、元数据、字节码、符号引用验证。
	
	>	验证阶段非常重要但是不是必须(可以通过关闭参数来省略)

2. 准备: 为类的静态变量分配空间,并设置默认值(0、0.0等)

	>	如果使用final修饰,默认值就是常量值

3. 解析：类|接口、字段、类方法、接口方法解析

	>	是将符号引用替换为直接引用的过程
	>	此过程可能会引发其他类的加载动作

-	Tips

>	符号引用:以一组符号表示引用的目标

>	直接引用:可以是目标的指针、相对偏移量或间接定位到目标的句柄	

###	初始化

	其实就是执行 类构造器<clinit>()方法
	
	>	先执行父类的<clinit>()
	
	>	<clinit>()在多线程中会被枷锁、同步。其他线程阻塞等待--想到了单例模式
	
-	初始化的时机

	所有的主动使用:new、对静态变量的读写、对静态方法的调用、对类进行反射(Class.forName()、ClassLoader.loadClass())	
	
	被动使用都不会加载:使用父类的静态变量、使用类的数组、使用类在常量池中的静态变量(在解析阶段直接引用了常量池)
	
-	Tips
	
>	<clinit>()方法不是必须的,类没有静态语句和变量,那就没有这个方法

>	接口也有<clinit>()方法,与类不同的时,接口不需要先执行父类的<clinit>()方法。同时类实现接口也不需要执行接口的<clinit>()

>	类的数组也是一个类,名字为：[Lxxxx。xxxx表示类名

##	Java中的赋值顺序

1. 父类的静态变量赋值 

2. 自身的静态变量赋值 

3. 父类成员变量赋值和父类块赋值 

4. 父类构造函数赋值 

5. 自身成员变量赋值和自身块赋值 

6. 自身构造函数赋值	

### 面试题

```java
public class StaticTest{

	public static void main(String[] args)
	{
		staticFunction();
	}
 
	static StaticTest st = new StaticTest();
 
	static
	{
		System.out.println("1");
	}
 
	{
		System.out.println("2");
	}
 
	StaticTest()
	{
		System.out.println("3");
		System.out.println("a="+a+",b="+b);
	}
 
	public static void staticFunction(){
		System.out.println("4");
	}
 
	int a=110;
	static int b =112;
}
```	

类初始化调用<clinit>()方法时,需要实例化对象,即调用<init>().实例完后再继续类初始化

out:
	2
	3
	a=110,b=0
	1
	4

参考：阿里巴巴《深入探索Android热修复技术原理》、《深入理解Java虚拟机》






